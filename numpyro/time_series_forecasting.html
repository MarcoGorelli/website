

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Time Series Forecasting &mdash; Numpyro Tutorials 0.2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/pyro.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Numpyro Tutorials 0.2.0 documentation" href="index.html"/>
        <link rel="next" title="Bayesian Neural Network" href="bnn.html"/>
        <link rel="prev" title="Bayesian Regression Using NumPyro" href="bayesian_regression.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html">
          

          
            
            <img src="_static/Pyro_logo_wide.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Examples:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bayesian_regression.html">Bayesian Regression Using NumPyro</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Time Series Forecasting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Data">Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model">Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Inference">Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Forecasting">Forecasting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Acknowledgements">Acknowledgements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Code Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bnn.html">Bayesian Neural Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="gp.html">Gaussian Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="ucbadmit.html">Generalized Linear Mixed Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="baseball.html">Baseball</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm.html">Hidden Markov Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="stochastic_volatility.html">Stochastic Volatility</a></li>
<li class="toctree-l1"><a class="reference internal" href="vae.html">Variational Autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="funnel.html">Neal’s Funnel</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_regression.html">Sparse Regression</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Numpyro Tutorials</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Time Series Forecasting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/time_series_forecasting.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Time-Series-Forecasting">
<h1>Time Series Forecasting<a class="headerlink" href="#Time-Series-Forecasting" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we will use <code class="docutils literal notranslate"><span class="pre">numpyro</span></code> to do forecasting.
Specifically, we will replicate the <strong>Seasonal, Global Trend (SGT)</strong>
model in <a class="reference external" href="https://cran.r-project.org/web/packages/Rlgt/index.html">Rlgt: Bayesian Exponential Smoothing Models with Trend
Modifications</a>
package. Data is the famous <strong>lynx</strong> time series, which contains annual
numbers of lynx trappings from 1821 to 1934 in Canada.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
    <span class="c1"># set this XLA flags to run 4 chains MCMC in parallel</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;XLA_FLAGS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;--xla_force_host_platform_device_count=4&#39;</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">vmap</span>
<span class="kn">from</span> <span class="nn">jax.config</span> <span class="kn">import</span> <span class="n">config</span><span class="p">;</span> <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_platform_name&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="kn">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.diagnostics</span> <span class="kn">import</span> <span class="n">autocorrelation</span><span class="p">,</span> <span class="n">hpdi</span>
<span class="kn">from</span> <span class="nn">numpyro.distributions.util</span> <span class="kn">import</span> <span class="n">softmax</span>
<span class="kn">from</span> <span class="nn">numpyro</span> <span class="kn">import</span> <span class="n">handlers</span>
<span class="kn">from</span> <span class="nn">numpyro.mcmc</span> <span class="kn">import</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span>
</pre></div>
</div>
</div>
<div class="section" id="Data">
<h2>Data<a class="headerlink" href="#Data" title="Permalink to this headline">¶</a></h2>
<p>First, let’s import and take a look at the dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/vincentarelbundock/Rdatasets/master/csv/datasets/lynx.csv&quot;</span>
<span class="n">lynx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">lynx</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Length of time series:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lynx</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Length of time series: 114
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/time_series_forecasting_5_1.png" src="_images/time_series_forecasting_5_1.png" />
</div>
</div>
<p>The time series has a length of 114 (a data point for each year), and by
looking at the plot, we can observe
<a class="reference external" href="https://en.wikipedia.org/wiki/Seasonality">seasonality</a> in this
dataset, which is the recurrence of similar patterns at specific time
periods. e.g.&nbsp;in this dataset, we observe a cyclical pattern every 10
years, but there is also a less obvious but clear spike in the number of
trappings every 40 years. Let us see if we can model this effect in
NumPyro.</p>
<p>In this tutorial, we will use the first 80 values for training and the
last 34 values for testing.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">80</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">80</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Model">
<h2>Model<a class="headerlink" href="#Model" title="Permalink to this headline">¶</a></h2>
<p>The model we are going to use is called <strong>Seasonal, Global Trend</strong>,
which when tested on 3003 time series of the <a class="reference external" href="https://forecasters.org/resources/time-series-data/m3-competition/">M-3
competition</a>,
has been known to outperform other models originally participating in
the competition:</p>
<p><a href="#id1"><span class="problematic" id="id2">:raw-latex:`\begin{equation*}
\begin{gathered}
\text{exp_val}_{t} = \text{level}_{t-1} + \text{coef_trend} \times \text{level}_{t-1}^{\text{pow_trend}} + \text{s}_t \times \text{level}_{t-1}^{\text{pow_season}}, \\
\sigma_{t} = \sigma \times \text{exp_val}_{t}^{\text{powx}} + \text{offset}, \\
y_{t} \sim \text{StudentT}(\nu, \text{exp_val}_{t}, \sigma_{t}),
\end{gathered}
\end{equation*}`</span></a></p>
<p>where <code class="docutils literal notranslate"><span class="pre">level</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code> follows the following recursion rules:</p>
<p><a href="#id3"><span class="problematic" id="id4">:raw-latex:`\begin{equation*}
\begin{gathered}
\text{level_p} =
\begin{cases}
y_t - \text{s}_t \times \text{level}_{t-1}^{\text{pow_season}} &amp; \text{if } t \le \text{seasonality}, \\
\text{Average} \left[y(t - \text{seasonality} + 1), \ldots, y(t)\right] &amp; \text{otherwise},
\end{cases} \\
\text{level}_{t} = \text{level_sm} \times \text{level_p} + (1 - \text{level_sm}) \times \text{level}_{t-1}, \\
\text{s}_{t + \text{seasonality}} = \text{s_sm} \times \frac{y_{t} - \text{level}_{t}}{\text{level}_{t-1}^{\text{pow_trend}}}
+ (1 - \text{s_sm}) \times \text{s}_{t}.
\end{gathered}
\end{equation*}`</span></a></p>
<p>A more detailed explanation for SGT model can be found in <a class="reference external" href="https://cran.r-project.org/web/packages/Rlgt/vignettes/GT_models.html">this
vignette</a>
from the authors of Rlgt package. Here we summarize the core ideas of
this model:</p>
<ul class="simple">
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Student%27s_t-distribution">Student’s
t-distribution</a>,
which has heavier tails than normal distribution, is used for the
likelihood.</li>
<li>The expected value <code class="docutils literal notranslate"><span class="pre">exp_val</span></code> consists of a trending component and a
seasonal component:<ul>
<li>The trend is governed by the map <span class="math notranslate nohighlight">\(x \mapsto x + ax^b\)</span>, where
<span class="math notranslate nohighlight">\(x\)</span> is <code class="docutils literal notranslate"><span class="pre">level</span></code>, <span class="math notranslate nohighlight">\(a\)</span> is <code class="docutils literal notranslate"><span class="pre">coef_trend</span></code>, and <span class="math notranslate nohighlight">\(b\)</span>
is <code class="docutils literal notranslate"><span class="pre">pow_trend</span></code>. Note that when <span class="math notranslate nohighlight">\(b \sim 0\)</span>, the trend is
linear with <span class="math notranslate nohighlight">\(a\)</span> is the slope, and when <span class="math notranslate nohighlight">\(b \sim 1\)</span>, the
trend is exponential with <span class="math notranslate nohighlight">\(a\)</span> is the rate. So that function
can cover a large family of trend.</li>
<li>When time changes, <code class="docutils literal notranslate"><span class="pre">level</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code> are updated to new values.
Coefficients <code class="docutils literal notranslate"><span class="pre">level_sm</span></code> and <code class="docutils literal notranslate"><span class="pre">s_sm</span></code> are used to make the
transition smoothly.</li>
</ul>
</li>
<li>When <code class="docutils literal notranslate"><span class="pre">powx</span></code> is near <span class="math notranslate nohighlight">\(0\)</span>, the error <span class="math notranslate nohighlight">\(\sigma_t\)</span> will be
nearly constant while when <code class="docutils literal notranslate"><span class="pre">powx</span></code> is near <span class="math notranslate nohighlight">\(1\)</span>, the error will
be propotional to the expected value.</li>
<li>There are several varieties of SGT. In this tutorial, we use
generalized seasonality and seasonal average method.</li>
</ul>
<p>Note that <code class="docutils literal notranslate"><span class="pre">level</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code> are updated recursively while we collect
the expected value at each time step. NumPyro uses
<a class="reference external" href="https://github.com/google/jax">JAX</a> in the backend to JIT compile
many critical parts of the NUTS algorithm, including the verlet
integrator and the tree building process. However, doing so using
Python’s <code class="docutils literal notranslate"><span class="pre">for</span></code> loop in the model will result in a long compilation
time for the model, so we use <code class="docutils literal notranslate"><span class="pre">jax.lax.scan</span></code> instead. A detailed
explanation for using this utility can be found in <a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.lax.scan.html#jax.lax.scan">lax.scan
documentation</a>.
Here we use it to collect expected values while the pair <code class="docutils literal notranslate"><span class="pre">(level,</span> <span class="pre">s)</span></code>
plays the role of carrying state.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">scan_exp_val</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">init_s</span><span class="p">,</span> <span class="n">level_sm</span><span class="p">,</span> <span class="n">s_sm</span><span class="p">,</span> <span class="n">coef_trend</span><span class="p">,</span> <span class="n">pow_trend</span><span class="p">,</span> <span class="n">pow_season</span><span class="p">):</span>
    <span class="n">seasonality</span> <span class="o">=</span> <span class="n">init_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">scan_fn</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="n">season</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">level</span> <span class="o">**</span> <span class="n">pow_season</span>
        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="n">coef_trend</span> <span class="o">*</span> <span class="n">level</span> <span class="o">**</span> <span class="n">pow_trend</span> <span class="o">+</span> <span class="n">season</span>
        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">exp_val</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">moving_sum</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="n">seasonality</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">level_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">moving_sum</span> <span class="o">/</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">season</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">level_sm</span> <span class="o">*</span> <span class="n">level_p</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">level_sm</span><span class="p">)</span> <span class="o">*</span> <span class="n">level</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_sm</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">season</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s_sm</span><span class="p">))</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">new_s</span><span class="p">[</span><span class="bp">None</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">moving_sum</span><span class="p">),</span> <span class="n">exp_val</span>

    <span class="n">level_init</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">init_s</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">init_s</span><span class="p">[:</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">level_init</span>
    <span class="p">(</span><span class="n">last_level</span><span class="p">,</span> <span class="n">last_s</span><span class="p">,</span> <span class="n">moving_sum</span><span class="p">),</span> <span class="n">exp_vals</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">scan_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">level_init</span><span class="p">,</span> <span class="n">s_init</span><span class="p">,</span> <span class="n">moving_sum</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">exp_vals</span><span class="p">,</span> <span class="n">last_level</span><span class="p">,</span> <span class="n">last_s</span>
</pre></div>
</div>
</div>
<p>With our utility function defined above, we are ready to specify the
model using <em>NumPyro</em> primitives. In NumPyro, we use the primitive
<code class="docutils literal notranslate"><span class="pre">sample(name,</span> <span class="pre">prior)</span></code> to declare a latent random variable with a
corresponding <code class="docutils literal notranslate"><span class="pre">prior</span></code>. These primitives can have custom
interpretations depending on the effect handlers that are used by
NumPyro inference algorithms in the backend. e.g.&nbsp;we can condition on
specific values using the <code class="docutils literal notranslate"><span class="pre">substitute</span></code> handler, or record values at
these sample sites in the execution trace using the <code class="docutils literal notranslate"><span class="pre">trace</span></code> handler.
Note that these details are not important for specifying the model, or
running inference, but curious readers are encouraged to read the
<a class="reference external" href="http://pyro.ai/examples/effect_handlers.html">tutorial on effect
handlers</a> in Pyro.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">sgt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">):</span>
    <span class="c1"># heuristically, standard derivation of Cauchy prior depends on the max value of data</span>
    <span class="n">cauchy_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">150</span>

    <span class="n">nu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;nu&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">powx</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;powx&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="n">cauchy_sd</span><span class="p">))</span>
    <span class="n">offset_sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;offset_sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">TruncatedCauchy</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
                                                                       <span class="n">scale</span><span class="o">=</span><span class="n">cauchy_sd</span><span class="p">))</span>

    <span class="n">coef_trend</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;coef_trend&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Cauchy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cauchy_sd</span><span class="p">))</span>
    <span class="n">pow_trend_beta</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pow_trend_beta&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># pow_trend takes values from -0.5 to 1</span>
    <span class="n">pow_trend</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">pow_trend_beta</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="n">pow_season</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pow_season&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">level_sm</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;level_sm&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">s_sm</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;s_sm&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">init_s</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;init_s&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Cauchy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">[:</span><span class="n">seasonality</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">))</span>

    <span class="n">exp_val</span><span class="p">,</span> <span class="n">last_level</span><span class="p">,</span> <span class="n">last_s</span> <span class="o">=</span> <span class="n">scan_exp_val</span><span class="p">(</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">init_s</span><span class="p">,</span> <span class="n">level_sm</span><span class="p">,</span> <span class="n">s_sm</span><span class="p">,</span> <span class="n">coef_trend</span><span class="p">,</span> <span class="n">pow_trend</span><span class="p">,</span> <span class="n">pow_season</span><span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">exp_val</span> <span class="o">**</span> <span class="n">powx</span> <span class="o">+</span> <span class="n">offset_sigma</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">exp_val</span><span class="p">,</span> <span class="n">omega</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1"># we return last `level` and last `s` for forecasting</span>
    <span class="k">return</span> <span class="n">last_level</span><span class="p">,</span> <span class="n">last_s</span>
</pre></div>
</div>
</div>
<p>Note that all prior parameters are retrieved from <a class="reference external" href="https://github.com/cbergmeir/Rlgt/blob/master/Rlgt/R/rlgtcontrol.R">this
file</a>
in the original source.</p>
</div>
<div class="section" id="Inference">
<h2>Inference<a class="headerlink" href="#Inference" title="Permalink to this headline">¶</a></h2>
<p>First, we want to choose a good value for <code class="docutils literal notranslate"><span class="pre">seasonality</span></code>. Following
<a class="reference external" href="https://github.com/cbergmeir/Rlgt/blob/master/Rlgt/demo/lynx.R">the demo in
Rlgt</a>,
we will set <code class="docutils literal notranslate"><span class="pre">seasonality=38</span></code>. Indeed, this value can be guessed by
looking at the plot of the training data, where the second order
seasonality effect has a periodicity around <span class="math notranslate nohighlight">\(40\)</span> years. Note that
<span class="math notranslate nohighlight">\(38\)</span> is also one of the highest-autocorrelation lags.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;Lag values sorted according to their autocorrelation values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">autocorrelation</span><span class="p">(</span><span class="n">y_train</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lag values sorted according to their autocorrelation values:

[ 0 67 57 38 68  1 29 58 37 56 28 10 19 39 66 78 47 77  9 79 48 76 30 18
 20 11 46 59 69 27 55 36  2  8 40 49 17 21 75 12 65 45 31 26  7 54 35 41
 50  3 22 60 70 16 44 13  6 25 74 53 42 32 23 43 51  4 15 14 34 24  5 52
 73 64 33 71 72 61 63 62]
</pre></div></div>
</div>
<p>Now, let us run <span class="math notranslate nohighlight">\(4\)</span> MCMC chains (using the No-U-Turn Sampler
algorithm) with <span class="math notranslate nohighlight">\(5000\)</span> warmup steps and <span class="math notranslate nohighlight">\(5000\)</span> sampling
steps per each chain. The returned value will be a collection of
<span class="math notranslate nohighlight">\(20000\)</span> samples.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">sgt</span><span class="p">)</span>
<span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">seasonality</span><span class="o">=</span><span class="mi">38</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


                      mean       std    median      5.0%     95.0%     n_eff     r_hat
      coef_trend     29.09     98.71     14.56    -91.73    145.81   4051.37      1.00
       init_s[0]     86.54    109.55     64.85    -66.83    238.14   5079.81      1.00
       init_s[1]    -19.97     71.69    -24.72   -131.59     89.60   6249.38      1.00
       init_s[2]     30.63     93.27     18.78   -115.05    170.77   6732.45      1.00
       init_s[3]    124.67    125.71    105.77    -61.38    313.86   8220.25      1.00
       init_s[4]    450.26    256.86    404.19     69.92    811.27   4448.72      1.00
       init_s[5]   1173.79    472.57   1098.92    488.84   1859.04   3314.14      1.00
       init_s[6]   2000.90    676.77   1901.23    945.56   2968.26   2475.09      1.00
       init_s[7]   3668.02   1094.74   3522.61   1922.71   5355.88   2290.69      1.00
       init_s[8]   2615.66    853.63   2500.75   1318.56   3872.21   2247.70      1.00
       init_s[9]    960.49    449.32    888.35    301.52   1617.85   4430.07      1.00
      init_s[10]     47.21    104.48     32.14   -100.97    210.64   7141.30      1.00
      init_s[11]      0.08     51.46     -1.45    -78.95     73.77   7024.68      1.00
      init_s[12]    -10.07     66.66    -11.91   -116.96     85.37   5806.46      1.00
      init_s[13]     67.89    103.73     49.13    -77.94    224.25   5639.26      1.00
      init_s[14]    337.20    259.23    285.19    -21.03    699.68   4651.92      1.00
      init_s[15]    972.55    388.29    908.73    384.28   1563.27   3408.84      1.00
      init_s[16]   1262.73    471.05   1191.14    562.77   1978.04   3121.38      1.00
      init_s[17]   1373.86    540.54   1289.35    567.12   2176.43   3687.15      1.00
      init_s[18]    622.45    322.41    563.86    162.68   1076.29   3973.87      1.00
      init_s[19]     18.64     91.97      6.81   -124.45    148.31   6213.87      1.00
      init_s[20]    -32.44     65.75    -28.33   -147.05     60.47   6893.09      1.00
      init_s[21]    -14.80     43.78     -4.94    -92.55     41.70   3377.48      1.00
      init_s[22]     -1.59     47.34     -1.85    -70.69     61.02   3289.25      1.00
      init_s[23]     37.89     83.32     24.47    -87.69    160.11   6764.21      1.00
      init_s[24]    526.37    334.56    469.03     16.20    993.17   5341.32      1.00
      init_s[25]    940.59    455.93    860.81    262.89   1603.91   4274.85      1.00
      init_s[26]   1798.68    686.21   1690.46    760.75   2825.67   3039.27      1.00
      init_s[27]   1278.57    483.00   1199.59    542.69   1977.18   3001.27      1.00
      init_s[28]    212.60    168.91    183.73    -33.79    457.07   5313.80      1.00
      init_s[29]    -10.88     82.46    -18.58   -139.01    115.83   7224.98      1.00
      init_s[30]     -4.65     88.48    -13.88   -141.02    130.79   6992.37      1.00
      init_s[31]    -35.23     73.35    -36.37   -155.13     71.20   8050.41      1.00
      init_s[32]     -8.97     83.43    -15.82   -137.54    116.97   7060.79      1.00
      init_s[33]    112.11    132.27     90.04    -88.37    305.03   6798.16      1.00
      init_s[34]    516.44    307.19    460.17     84.12    944.83   4775.00      1.00
      init_s[35]   1073.32    447.13    996.76    411.99   1748.25   3658.37      1.00
      init_s[36]   1860.83    665.66   1761.13    837.76   2808.02   2897.86      1.00
      init_s[37]   1456.82    560.72   1374.89    610.81   2259.73   3060.17      1.00
        level_sm      0.00      0.00      0.00      0.00      0.00  11155.23      1.00
              nu     12.30      4.79     12.68      5.37     19.98  10606.47      1.00
    offset_sigma     32.44     30.30     23.84      0.00     72.22   9096.21      1.00
      pow_season      0.09      0.04      0.08      0.01      0.15   1426.34      1.00
  pow_trend_beta      0.25      0.16      0.23      0.00      0.49   4299.17      1.00
            powx      0.62      0.13      0.62      0.40      0.83   4965.34      1.00
            s_sm      0.08      0.09      0.05      0.00      0.19   8338.49      1.00
           sigma      9.74      9.54      6.83      0.36     20.86   7252.87      1.00


</pre></div></div>
</div>
</div>
<div class="section" id="Forecasting">
<h2>Forecasting<a class="headerlink" href="#Forecasting" title="Permalink to this headline">¶</a></h2>
<p>Given <code class="docutils literal notranslate"><span class="pre">samples</span></code> from <code class="docutils literal notranslate"><span class="pre">mcmc</span></code>, we want to do forecasting for the
testing dataset <code class="docutils literal notranslate"><span class="pre">y_test</span></code>. First, we will make some utilities to do
forecasting given a sample. Note that to retrieve the last <code class="docutils literal notranslate"><span class="pre">level</span></code> and
last <code class="docutils literal notranslate"><span class="pre">s</span></code> value, we substitute a sample to the model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>    <span class="n">level</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">substitute</span><span class="p">(</span><span class="n">sgt</span><span class="p">,</span> <span class="n">asample</span><span class="p">)(</span><span class="n">y</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">)</span>
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Ref: https://github.com/cbergmeir/Rlgt/blob/master/Rlgt/R/forecast.rlgtfit.R</span>
<span class="k">def</span> <span class="nf">sgt_forecast</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">asample</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">seasonality</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">seasonality</span><span class="p">:])</span>
    <span class="n">pow_trend</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">asample</span><span class="p">[</span><span class="s2">&quot;pow_trend_beta&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="n">yfs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">seasonality</span> <span class="o">+</span> <span class="n">future</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
        <span class="n">season</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">level</span> <span class="o">**</span> <span class="n">asample</span><span class="p">[</span><span class="s2">&quot;pow_season&quot;</span><span class="p">]</span>
        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="n">asample</span><span class="p">[</span><span class="s2">&quot;coef_trend&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">level</span> <span class="o">**</span> <span class="n">pow_trend</span> <span class="o">+</span> <span class="n">season</span>
        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">exp_val</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="n">asample</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp_val</span> <span class="o">**</span> <span class="n">asample</span><span class="p">[</span><span class="s2">&quot;powx&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">asample</span><span class="p">[</span><span class="s2">&quot;offset_sigma&quot;</span><span class="p">]</span>
        <span class="n">yf</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;yf[{}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">dist</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="n">asample</span><span class="p">[</span><span class="s2">&quot;nu&quot;</span><span class="p">],</span> <span class="n">exp_val</span><span class="p">,</span> <span class="n">omega</span><span class="p">))</span>
        <span class="n">yf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">yf</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-30</span><span class="p">)</span>
        <span class="n">yfs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf</span>

        <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">moving_sum</span> <span class="o">+</span> <span class="n">yf</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">seasonality</span><span class="p">,</span>
                                                <span class="n">yfs</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="n">seasonality</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">seasonality</span> <span class="o">+</span> <span class="n">t</span><span class="p">])</span>
        <span class="n">level_p</span> <span class="o">=</span> <span class="n">moving_sum</span> <span class="o">/</span> <span class="n">seasonality</span>
        <span class="n">level_tmp</span> <span class="o">=</span> <span class="n">asample</span><span class="p">[</span><span class="s2">&quot;level_sm&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">level_p</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">asample</span><span class="p">[</span><span class="s2">&quot;level_sm&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">level</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">level_tmp</span> <span class="o">&gt;</span> <span class="mf">1e-30</span><span class="p">,</span> <span class="n">level_tmp</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="c1"># s is repeated instead of being updated</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">s</span><span class="p">[:</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">forecast</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">asample</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">):</span>
    <span class="n">level</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">sgt</span><span class="p">,</span> <span class="n">asample</span><span class="p">)(</span><span class="n">y</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">)</span>
    <span class="n">forecast_model</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">sgt_forecast</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
    <span class="n">forecast_trace</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">forecast_model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">asample</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">forecast_trace</span><span class="p">[</span><span class="s2">&quot;yf[{}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-30</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">future</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then, we can use
<a class="reference external" href="https://jax.readthedocs.io/en/latest/jax.html#jax.vmap">jax.vmap</a> to
get prediction given a collection of samples. This allows us to
vectorize the computation across the test dataset which can be
dramatically faster as compared to using for-loop to collect predictions
per test data point.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rngs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;nu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">forecast_marginal</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rng</span><span class="p">,</span> <span class="n">asample</span><span class="p">:</span> <span class="n">forecast</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span> <span class="n">rng</span><span class="p">,</span> <span class="n">asample</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">seasonality</span><span class="o">=</span><span class="mi">38</span><span class="p">))(</span><span class="n">rngs</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, let’s get sMAPE, root mean square error of the prediction, and
visualize the result with the mean prediction and the 89% highest
posterior density interval (HPDI).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">forecast_marginal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sMAPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">+</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">200</span>
<span class="n">msqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;sMAPE: {:.2f}, rmse: {:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sMAPE</span><span class="p">,</span> <span class="n">msqrt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sMAPE: 62.73, rmse: 1243.96
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lynx</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">)</span>
<span class="n">t_future</span> <span class="o">=</span> <span class="n">lynx</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">80</span><span class="p">:]</span>
<span class="n">hpd_low</span><span class="p">,</span> <span class="n">hpd_high</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">forecast_marginal</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_future</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">t_future</span><span class="p">,</span> <span class="n">hpd_low</span><span class="p">,</span> <span class="n">hpd_high</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Forecasting lynx dataset with SGT model (90% HPDI)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/time_series_forecasting_28_0.png" src="_images/time_series_forecasting_28_0.png" />
</div>
</div>
<p>As we can observe, the model has been able to learn both the first and
second order seasonality effects, i.e.&nbsp;a cyclical pattern with a
periodicity of around 10, as well as spikes that can be seen once every
40 or so years. Moreover, we not only have point estimates for the
forecast but can also use the uncertainty estimates from the model to
bound our forecasts.</p>
</div>
<div class="section" id="Acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#Acknowledgements" title="Permalink to this headline">¶</a></h2>
<p>We would like to thank Slawek Smyl for many helpful resources and
suggestions. Fast inference would not have been possible without the
support of JAX and the XLA teams, so we would like to thank them for
providing such a great open-source platform for us to build on, and for
their responsiveness in dealing with our feature requests and bug
reports.</p>
</div>
<div class="section" id="References">
<h2>References<a class="headerlink" href="#References" title="Permalink to this headline">¶</a></h2>
<p>[1]
<code class="docutils literal notranslate"><span class="pre">Rlgt:</span> <span class="pre">Bayesian</span> <span class="pre">Exponential</span> <span class="pre">Smoothing</span> <span class="pre">Models</span> <span class="pre">with</span> <span class="pre">Trend</span> <span class="pre">Modifications</span></code>,
Slawek Smyl, Christoph Bergmeir, Erwin Wibowo, To Wang Ng, Trustees of
Columbia University</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bnn.html" class="btn btn-neutral float-right" title="Bayesian Neural Network" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bayesian_regression.html" class="btn btn-neutral" title="Bayesian Regression Using NumPyro" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Uber Technologies, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>